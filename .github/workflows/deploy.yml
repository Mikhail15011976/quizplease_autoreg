name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      env:
        SSH_KEY: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        HOST: ${{ secrets.SERVER_HOST }}
        USER: ${{ secrets.SERVER_USER }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        cat > ~/.ssh/config << EOF
        Host deploy-server
          HostName $HOST
          User $USER
          IdentityFile ~/.ssh/deploy_key
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
    
    - name: Fix Git and Deploy
      run: |
        echo "üöÄ Starting deployment with Git fix..."
        
        ssh deploy-server "
          set -e
          echo '=== STARTING DEPLOYMENT ==='
          echo 'Time: \$(date)'
          
          echo ''
          echo 'üßπ Step 1: Fixing Git references...'
          cd /opt/quizplease-autoreg
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git stash 2>/dev/null || true
          
          # –û—á–∏—â–∞–µ–º –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git checkout -- .
          git clean -fd
          
          # –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å—Å—ã–ª–∫–∏
          echo 'Cleaning Git refs...'
          rm -f .git/refs/remotes/origin/main 2>/dev/null || true
          rm -f .git/refs/heads/main 2>/dev/null || true
          
          # –û—á–∏—â–∞–µ–º Git –∫—ç—à
          git gc --prune=now
          git remote prune origin
          
          echo ''
          echo 'üîÑ Step 2: Forcing fresh pull...'
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º force –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          git fetch origin --force
          
          # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ç–∫—É main
          git checkout -B main origin/main --force
          
          echo 'Current commit:'
          git log --oneline -1
          
          echo ''
          echo 'üì¶ Step 3: Installing dependencies...'
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          echo ''
          echo '‚öôÔ∏è Step 4: Reloading systemd...'
          sudo systemctl daemon-reload
          
          echo ''
          echo '‚úÖ Step 5: Testing script...'
          echo 'Running test command...'
          cd /opt/quizplease-autoreg
          source venv/bin/activate
          python -c \"import sys; print('Python version:', sys.version[:20])\"
          
          echo ''
          echo 'üéâ DEPLOYMENT COMPLETED SUCCESSFULLY!'
          echo 'Time: \$(date)'
          echo ''
          echo 'To run manually:'
          echo '  cd /opt/quizplease-autoreg'
          echo '  source venv/bin/activate'
          echo '  python src/extract_classic_games.py'
          
          echo ''
          echo 'Systemd service status:'
          sudo systemctl status quizplease-autoreg --no-pager | head -10
        "