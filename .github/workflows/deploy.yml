name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      env:
        SSH_KEY: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        HOST: ${{ secrets.SERVER_HOST }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/key
        chmod 600 ~/.ssh/key
        
        cat > ~/.ssh/config << EOF
        Host server
          HostName $HOST
          User mikhail
          IdentityFile ~/.ssh/key
          StrictHostKeyChecking no
        EOF
    
    - name: Deploy Application
      run: |
        echo "ðŸš€ Deploying QuizPlease Autoreg..."
        
        ssh server "
          set -e
          
          echo '=== DEPLOYMENT STARTED ==='
          echo 'Time: \$(date)'
          
          echo ''
          echo '1. Updating source code...'
          cd /opt/quizplease-autoreg
          git fetch origin
          git checkout main
          git reset --hard origin/main
          
          echo 'Latest commit: \$(git log --oneline -1)'
          
          echo ''
          echo '2. Installing Python dependencies...'
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          echo ''
          echo '3. Reloading systemd configuration...'
          sudo systemctl daemon-reload
          
          echo ''
          echo '4. Testing the script...'
          echo 'Running one test execution:'
          timeout 30 python src/extract_classic_games.py || echo 'Script completed'
          
          echo ''
          echo '5. Checking systemd status...'
          echo 'Service configuration:'
          sudo systemctl status quizplease-autoreg --no-pager | head -15
          
          echo ''
          echo '6. Timer status (if exists):'
          if [ -f '/etc/systemd/system/quizplease-autoreg.timer' ]; then
            sudo systemctl status quizplease-autoreg.timer --no-pager | head -10
            echo ''
            echo 'Restarting timer...'
            sudo systemctl restart quizplease-autoreg.timer
            echo 'Timer restarted'
          else
            echo 'No timer found (manual execution only)'
          fi
          
          echo ''
          echo '=== DEPLOYMENT COMPLETED ==='
          echo 'âœ… Code updated successfully!'
          echo ''
          echo 'To run manually:'
          echo '  cd /opt/quizplease-autoreg'
          echo '  source venv/bin/activate'
          echo '  python src/extract_classic_games.py'
          echo ''
          echo 'Or start service once:'
          echo '  sudo systemctl start quizplease-autoreg'
          echo ''
          echo 'Completed at: \$(date)'
        "