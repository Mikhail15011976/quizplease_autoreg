name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      env:
        SSH_KEY: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        HOST: ${{ secrets.SERVER_HOST }}
        USER: ${{ secrets.SERVER_USER }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        cat > ~/.ssh/config << EOF
        Host deploy-server
          HostName $HOST
          User $USER
          IdentityFile ~/.ssh/deploy_key
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
    
    - name: Fix Git and Deploy
      run: |
        echo "ðŸš€ Starting deployment with Git fix..."
        
        ssh deploy-server "
          set -e
          echo '=== STARTING DEPLOYMENT ==='
          echo 'Time: \$(date)'
          
          echo ''
          echo 'ðŸ§¹ Step 1: Fixing Git references...'
          cd /opt/quizplease-autoreg
          
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð»ÑŽÐ±Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          git stash 2>/dev/null || true
          
          # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²ÑÐµ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          git checkout -- .
          git clean -fd
          
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð½Ñ‹Ðµ ÑÑÑ‹Ð»ÐºÐ¸
          echo 'Cleaning Git refs...'
          rm -f .git/refs/remotes/origin/main 2>/dev/null || true
          rm -f .git/refs/heads/main 2>/dev/null || true
          
          # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Git ÐºÑÑˆ
          git gc --prune=now
          git remote prune origin
          
          echo ''
          echo 'ðŸ”„ Step 2: Forcing fresh pull...'
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ force Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
          git fetch origin --force
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð²ÐµÑ‚ÐºÑƒ main
          git checkout -B main origin/main --force
          
          echo 'Current commit:'
          git log --oneline -1
          
          echo ''
          echo 'ðŸ“¦ Step 3: Installing dependencies...'
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          echo ''
          echo 'âš™ï¸ Step 4: Reloading systemd...'
          sudo systemctl daemon-reload
          
          echo ''
          echo 'âœ… Step 5: Testing script...'
          echo 'Running test command...'
          cd /opt/quizplease-autoreg
          source venv/bin/activate
          python -c "import sys; print('âœ… Python works:', sys.version)" 2>&1 | head -1
          
          echo ''
          echo 'ðŸŽ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!'
          echo 'Time: \$(date)'
          echo ''
          echo 'To run manually:'
          echo '  cd /opt/quizplease-autoreg'
          echo '  source venv/bin/activate'
          echo '  python src/extract_classic_games.py'
          
          echo ''
          echo 'Systemd service status:'
          sudo systemctl status quizplease-autoreg --no-pager | head -10
        "