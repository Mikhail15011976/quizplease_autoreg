name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH Connection
      env:
        SSH_KEY: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        HOST: ${{ secrets.SERVER_HOST }}
        USER: ${{ secrets.SERVER_USER }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        cat > ~/.ssh/config << EOF
        Host deploy-server
          HostName $HOST
          User $USER
          IdentityFile ~/.ssh/deploy_key
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
    
    - name: Clean and Deploy
      run: |
        echo "ðŸš€ Starting clean deployment..."
        
        ssh deploy-server "
          set -e
          echo '=== DEPLOYMENT STARTED ==='
          echo 'Time: \$(date)'
          
          echo ''
          echo 'ðŸ§¹ Step 1: Cleaning Git state'
          cd /opt/quizplease-autoreg
          
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð»ÑŽÐ±Ñ‹Ðµ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ (Ð½Ð° Ð²ÑÑÐºÐ¸Ð¹ ÑÐ»ÑƒÑ‡Ð°Ð¹)
          git stash
          
          # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²ÑÐµ Ð½ÐµÐ¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          git clean -fd
          
          # Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ð²ÑÐµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          git reset --hard
          
          echo ''
          echo 'ðŸ”„ Step 2: Fetching latest code'
          # ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµ ÑÑÑ‹Ð»ÐºÐ¸
          git fetch origin --force
          
          # ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ð½Ð° main Ð¸ ÑÐ±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼
          git checkout main --force
          git reset --hard origin/main --recurse-submodules
          
          echo 'Latest commit:'
          git log --oneline -1
          
          echo ''
          echo 'ðŸ“¦ Step 3: Updating dependencies'
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          echo ''
          echo 'âš™ï¸ Step 4: Restarting service'
          sudo systemctl daemon-reload
          sudo systemctl restart quizplease-autoreg
          
          echo ''
          echo 'âœ… Step 5: Verification'
          sleep 3
          
          echo 'Service status:'
          SYSTEMCTL_STATUS=\$(sudo systemctl status quizplease-autoreg --no-pager | head -5)
          echo \"\$SYSTEMCTL_STATUS\"
          
          if sudo systemctl is-active quizplease-autoreg >/dev/null 2>&1; then
            echo 'ðŸŸ¢ Service is ACTIVE and RUNNING'
            echo ''
            echo 'ðŸŽ‰ DEPLOYMENT SUCCESSFUL!'
            echo 'Completed at: \$(date)'
          else
            echo 'ðŸ”´ Service FAILED to start'
            echo 'Last 10 log lines:'
            sudo journalctl -u quizplease-autoreg -n 10 --no-pager
            exit 1
          fi
        "