name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup SSH
      env:
        SSH_KEY: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        HOST: ${{ secrets.SERVER_HOST }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/key
        chmod 600 ~/.ssh/key
        echo "Host $HOST" >> ~/.ssh/config
        echo "  IdentityFile ~/.ssh/key" >> ~/.ssh/config
        echo "  StrictHostKeyChecking no" >> ~/.ssh/config

    - name: Deploy
      env:
        HOST: ${{ secrets.SERVER_HOST }}
        USER: ${{ secrets.SERVER_USER }}
      run: |
        echo "ðŸš€ Deploying to $HOST..."

        ssh $USER@$HOST '
          set -e
          cd /opt/quizplease-autoreg

          echo "1. Updating code..."
          git fetch origin
          git checkout main
          git reset --hard origin/main

          echo "2. Updating dependencies..."
          source venv/bin/activate
          pip install -r requirements.txt

          echo "3. Reloading systemd..."
          sudo -n systemctl daemon-reload

          echo "4. Restarting service..."
          sudo -n systemctl restart quizplease-autoreg

          echo "âœ… Service restarted successfully!"
        '
