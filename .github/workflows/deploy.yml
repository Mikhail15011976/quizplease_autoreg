name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      env:
        SSH_KEY: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        HOST: ${{ secrets.SERVER_HOST }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/key
        chmod 600 ~/.ssh/key
        echo "Host $HOST" >> ~/.ssh/config
        echo "  IdentityFile ~/.ssh/key" >> ~/.ssh/config
        echo "  StrictHostKeyChecking no" >> ~/.ssh/config
    
    - name: Deploy to Server
      env:
        HOST: ${{ secrets.SERVER_HOST }}
        USER: ${{ secrets.SERVER_USER }}
      run: |
        echo "üöÄ Deploying to $HOST..."
        
        # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ SSH —Å sudo
        ssh $USER@$HOST '
          set -e  # –ü—Ä–µ—Ä—ã–≤–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ
          
          echo "1. Updating code in /opt/quizplease-autoreg..."
          cd /opt/quizplease-autoreg
          
          echo "2. Pulling latest changes..."
          git fetch origin
          git checkout main
          git reset --hard origin/main
          
          echo "3. Activating virtual environment..."
          source venv/bin/activate
          
          echo "4. Installing dependencies..."
          pip install -r requirements.txt
          
          echo "5. Fixing permissions..."
          # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã
          chmod +x src/*.py
          
          echo "6. Restarting service as root..."
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ —á–µ—Ä–µ–∑ sudo
          sudo systemctl daemon-reload
          sudo systemctl restart quizplease-autoreg
          
          echo "7. Checking service status..."
          sudo systemctl status quizplease-autoreg --no-pager | head -20
          
          echo "‚úÖ Deployment completed successfully!"
        '